<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-21 EMA Paper Trader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 800: '#1a1a2e', 900: '#0f0f23', 700: '#16213e' },
                        accent: { 500: '#0f3460', 400: '#533483', 300: '#e94560' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
<div id="app" v-cloak>
    <!-- NAV -->
    <nav class="bg-gray-900 border-b border-gray-800 px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <h1 class="text-xl font-bold text-emerald-400">8-21 EMA</h1>
            <span class="text-gray-500 text-sm">Paper Trader</span>
        </div>
        <div class="flex gap-1">
            <button v-for="t in tabs" :key="t.id"
                @click="tab = t.id"
                :class="tab === t.id ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white hover:bg-gray-800'"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                {{ t.label }}
            </button>
        </div>
        <div class="flex items-center gap-3">
            <span v-if="regime" class="text-xs font-bold px-2 py-0.5 rounded"
                :class="{'bg-emerald-500/20 text-emerald-400': regime === 'BULL',
                          'bg-red-500/20 text-red-400': regime === 'BEAR',
                          'bg-yellow-500/20 text-yellow-400': regime === 'MIXED',
                          'bg-gray-500/20 text-gray-400': regime === 'UNKNOWN'}">
                {{ regime }}
            </span>
            <span class="w-2 h-2 rounded-full" :class="scanning ? 'bg-yellow-400 animate-pulse' : 'bg-emerald-400'"></span>
            <span class="text-xs text-gray-500">{{ scanning ? 'Scanning...' : 'Idle' }}</span>
            <span v-if="userEmail" class="text-xs text-gray-400 border-l border-gray-700 pl-3 ml-2">{{ userEmail }}</span>
            <a v-if="userEmail" href="/auth/logout"
               class="text-xs text-gray-500 hover:text-gray-300 transition-colors">
                Logout
            </a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4">
        <!-- DASHBOARD -->
        <div v-if="tab === 'dashboard'">
            <!-- Portfolio Cards -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Cash</div>
                    <div class="text-xl font-bold text-white mt-1">{{ fmt(portfolio.cash) }}</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Positions</div>
                    <div class="text-xl font-bold text-white mt-1">{{ fmt(portfolio.positions_value) }}</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Total Equity</div>
                    <div class="text-xl font-bold text-white mt-1">{{ fmt(portfolio.total_equity) }}</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Unrealized P&L</div>
                    <div class="text-xl font-bold mt-1" :class="portfolio.unrealized_pnl >= 0 ? 'text-emerald-400' : 'text-red-400'">
                        {{ fmt(portfolio.unrealized_pnl) }}
                    </div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Net P&L</div>
                    <div class="text-xl font-bold mt-1" :class="portfolio.net_pnl >= 0 ? 'text-emerald-400' : 'text-red-400'">
                        {{ fmt(portfolio.net_pnl) }}
                    </div>
                </div>
            </div>

            <!-- Equity Curve -->
            <div class="bg-gray-900 rounded-xl p-4 border border-gray-800 mb-6">
                <h2 class="text-sm font-semibold text-gray-400 mb-3">Equity Curve</h2>
                <canvas id="equityChart" height="100"></canvas>
                <p v-if="equityCurve.length === 0" class="text-gray-600 text-sm text-center py-8">
                    No equity data yet. Snapshots recorded daily.
                </p>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800" v-for="s in statCards" :key="s.label">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">{{ s.label }}</div>
                    <div class="text-lg font-bold mt-1" :class="s.color || 'text-white'">{{ s.value }}</div>
                </div>
            </div>

            <!-- Notifications Feed -->
            <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <h2 class="text-sm font-semibold text-gray-400 mb-3">Activity Feed</h2>
                <div class="space-y-1 max-h-48 overflow-y-auto">
                    <div v-for="n in notifications" :key="n.id"
                        class="flex items-center gap-2 text-xs py-1 border-b border-gray-800/30">
                        <span class="w-1.5 h-1.5 rounded-full flex-shrink-0"
                            :class="n.level === 'warning' ? 'bg-yellow-400' : 'bg-emerald-400'"></span>
                        <span class="text-gray-500 flex-shrink-0">{{ n.created_at?.slice(5,16) }}</span>
                        <span class="text-gray-300">{{ n.message }}</span>
                    </div>
                    <p v-if="notifications.length === 0" class="text-gray-600 text-xs text-center py-4">
                        No activity yet.
                    </p>
                </div>
            </div>
        </div>

        <!-- POSITIONS -->
        <div v-if="tab === 'positions'">
            <!-- Manual Buy Form -->
            <div class="bg-gray-900 rounded-xl p-4 border border-gray-800 mb-6">
                <h2 class="text-sm font-semibold text-gray-400 mb-3">Open Manual Position</h2>
                <div class="grid grid-cols-2 md:grid-cols-7 gap-3">
                    <input v-model="buyForm.symbol" placeholder="Symbol (e.g. BHP.AX)" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:border-emerald-500 focus:outline-none">
                    <input v-model.number="buyForm.price" type="number" step="0.01" placeholder="Entry Price" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:border-emerald-500 focus:outline-none">
                    <input v-model.number="buyForm.stop_price" type="number" step="0.01" placeholder="Stop Price" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:border-emerald-500 focus:outline-none">
                    <input v-model.number="buyForm.target1_price" type="number" step="0.01" placeholder="Target 1" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:border-emerald-500 focus:outline-none">
                    <input v-model.number="buyForm.target2_price" type="number" step="0.01" placeholder="Target 2" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:border-emerald-500 focus:outline-none">
                    <input v-model.number="buyForm.shares" type="number" placeholder="Shares (auto)" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:border-emerald-500 focus:outline-none">
                    <button @click="manualBuy" class="bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-colors">
                        BUY
                    </button>
                </div>
            </div>

            <!-- Open Positions Table -->
            <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-800 text-gray-500 text-xs uppercase">
                            <th class="px-4 py-3 text-left">Symbol</th>
                            <th class="px-4 py-3 text-right">Shares</th>
                            <th class="px-4 py-3 text-right">Entry</th>
                            <th class="px-4 py-3 text-right">Current</th>
                            <th class="px-4 py-3 text-right">P&L</th>
                            <th class="px-4 py-3 text-right">P&L %</th>
                            <th class="px-4 py-3 text-right">Stop</th>
                            <th class="px-4 py-3 text-right">T1</th>
                            <th class="px-4 py-3 text-right">T2</th>
                            <th class="px-4 py-3 text-center">T1 Hit</th>
                            <th class="px-4 py-3 text-right">Date</th>
                            <th class="px-4 py-3"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="p in positions" :key="p.id" class="border-b border-gray-800/50 hover:bg-gray-800/30">
                            <td class="px-4 py-3 font-medium text-white">{{ p.symbol }}</td>
                            <td class="px-4 py-3 text-right">{{ p.shares }}<span v-if="p.shares !== p.initial_shares" class="text-gray-500 text-xs">/{{ p.initial_shares }}</span></td>
                            <td class="px-4 py-3 text-right">${{ p.entry_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-right">${{ p.current_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-right font-medium" :class="p.unrealized_pnl >= 0 ? 'text-emerald-400' : 'text-red-400'">
                                {{ fmt(p.unrealized_pnl) }}
                            </td>
                            <td class="px-4 py-3 text-right" :class="p.pnl_pct >= 0 ? 'text-emerald-400' : 'text-red-400'">
                                {{ p.pnl_pct.toFixed(2) }}%
                            </td>
                            <td class="px-4 py-3 text-right text-red-400">${{ p.stop_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-right text-yellow-400">${{ p.target1_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-right text-emerald-400">${{ p.target2_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-center">
                                <span v-if="p.target1_hit" class="text-yellow-400 text-xs font-bold">YES</span>
                                <span v-else class="text-gray-600 text-xs">no</span>
                            </td>
                            <td class="px-4 py-3 text-right text-gray-500 text-xs">{{ p.entry_date?.slice(0,10) }}</td>
                            <td class="px-4 py-3 text-right">
                                <button @click="closePosition(p)" class="text-red-400 hover:text-red-300 text-xs font-medium px-2 py-1 rounded border border-red-400/30 hover:border-red-400">
                                    CLOSE
                                </button>
                            </td>
                        </tr>
                        <tr v-if="positions.length === 0">
                            <td colspan="12" class="px-4 py-8 text-center text-gray-600">No open positions</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- JOURNAL -->
        <div v-if="tab === 'journal'">
            <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-800 text-gray-500 text-xs uppercase">
                            <th class="px-4 py-3 text-left">#</th>
                            <th class="px-4 py-3 text-left">Symbol</th>
                            <th class="px-4 py-3 text-right">Shares</th>
                            <th class="px-4 py-3 text-right">Entry</th>
                            <th class="px-4 py-3 text-right">Exit</th>
                            <th class="px-4 py-3 text-right">Gross P&L</th>
                            <th class="px-4 py-3 text-right">Net P&L</th>
                            <th class="px-4 py-3 text-right">R:R</th>
                            <th class="px-4 py-3 text-left">Reason</th>
                            <th class="px-4 py-3 text-right">Entry Date</th>
                            <th class="px-4 py-3 text-right">Exit Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(t, i) in journal" :key="t.id" class="border-b border-gray-800/50 hover:bg-gray-800/30">
                            <td class="px-4 py-3 text-gray-500">{{ journal.length - i }}</td>
                            <td class="px-4 py-3 font-medium text-white">{{ t.symbol }}</td>
                            <td class="px-4 py-3 text-right">{{ t.initial_shares }}</td>
                            <td class="px-4 py-3 text-right">${{ t.entry_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-right">${{ t.close_price?.toFixed(2) || '-' }}</td>
                            <td class="px-4 py-3 text-right font-medium" :class="t.gross_pnl >= 0 ? 'text-emerald-400' : 'text-red-400'">
                                {{ fmt(t.gross_pnl) }}
                            </td>
                            <td class="px-4 py-3 text-right font-medium" :class="t.net_pnl >= 0 ? 'text-emerald-400' : 'text-red-400'">
                                {{ fmt(t.net_pnl) }}
                            </td>
                            <td class="px-4 py-3 text-right" :class="t.rr_ratio >= 1 ? 'text-emerald-400' : 'text-red-400'">
                                {{ t.rr_ratio }}R
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-0.5 rounded-full text-xs"
                                    :class="{
                                        'bg-red-400/10 text-red-400': t.close_reason === 'stop',
                                        'bg-yellow-400/10 text-yellow-400': t.close_reason === 'target1_partial',
                                        'bg-emerald-400/10 text-emerald-400': t.close_reason === 'target2',
                                        'bg-gray-400/10 text-gray-400': t.close_reason === 'manual'
                                    }">
                                    {{ t.close_reason }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-right text-gray-500 text-xs">{{ t.entry_date?.slice(0,10) }}</td>
                            <td class="px-4 py-3 text-right text-gray-500 text-xs">{{ t.close_date?.slice(0,10) }}</td>
                        </tr>
                        <tr v-if="journal.length === 0">
                            <td colspan="11" class="px-4 py-8 text-center text-gray-600">No closed trades yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SCANNER -->
        <div v-if="tab === 'scanner'">
            <div class="flex items-center gap-4 mb-4">
                <button @click="runScan" :disabled="scanning"
                    class="bg-emerald-600 hover:bg-emerald-500 disabled:bg-gray-700 disabled:text-gray-500 text-white rounded-lg px-6 py-2 text-sm font-medium transition-colors">
                    {{ scanning ? 'Scanning...' : 'Run Scan Now' }}
                </button>
                <label class="flex items-center gap-2 text-sm text-gray-400">
                    <input type="checkbox" v-model="autoTrade" @change="toggleAutoTrade"
                        class="rounded border-gray-600 bg-gray-800 text-emerald-500 focus:ring-emerald-500">
                    Auto-Trade Signals
                </label>
                <span v-if="lastScanResult" class="text-sm text-gray-500">
                    Last scan: {{ lastScanResult.signals_found }} signal(s) found
                </span>
            </div>

            <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-800 text-gray-500 text-xs uppercase">
                            <th class="px-4 py-3 text-left">Symbol</th>
                            <th class="px-4 py-3 text-right">Price</th>
                            <th class="px-4 py-3 text-center">Score</th>
                            <th class="px-4 py-3 text-right">ADX</th>
                            <th class="px-4 py-3 text-right">Vol</th>
                            <th class="px-4 py-3 text-right">DeMarker</th>
                            <th class="px-4 py-3 text-right">Stop</th>
                            <th class="px-4 py-3 text-right">Target 1</th>
                            <th class="px-4 py-3 text-right">Target 2</th>
                            <th class="px-4 py-3 text-center">Traded</th>
                            <th class="px-4 py-3 text-right">Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="r in scanResults" :key="r.id" class="border-b border-gray-800/50 hover:bg-gray-800/30">
                            <td class="px-4 py-3 font-medium text-white">{{ r.symbol }}</td>
                            <td class="px-4 py-3 text-right">${{ r.price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-0.5 rounded-full text-xs font-bold"
                                    :class="(r.confidence||0) >= 70 ? 'bg-emerald-500/20 text-emerald-400' :
                                            (r.confidence||0) >= 50 ? 'bg-yellow-500/20 text-yellow-400' :
                                            'bg-gray-500/20 text-gray-400'">
                                    {{ r.confidence || '—' }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-right">{{ r.adx ? r.adx.toFixed(1) : '—' }}</td>
                            <td class="px-4 py-3 text-right" :class="(r.relative_volume||0) >= 1.5 ? 'text-emerald-400 font-medium' : ''">
                                {{ r.relative_volume ? r.relative_volume.toFixed(1) + 'x' : '—' }}
                            </td>
                            <td class="px-4 py-3 text-right">{{ r.demarker.toFixed(4) }}</td>
                            <td class="px-4 py-3 text-right text-red-400">${{ r.stop_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-right text-yellow-400">${{ r.target1_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-right text-emerald-400">${{ r.target2_price.toFixed(2) }}</td>
                            <td class="px-4 py-3 text-center">
                                <span v-if="r.auto_traded" class="text-emerald-400 text-xs font-bold">YES</span>
                                <span v-else class="text-gray-600 text-xs">no</span>
                            </td>
                            <td class="px-4 py-3 text-right text-gray-500 text-xs">{{ r.scanned_at }}</td>
                        </tr>
                        <tr v-if="scanResults.length === 0">
                            <td colspan="11" class="px-4 py-8 text-center text-gray-600">No scanner results yet. Click "Run Scan Now" to start.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SETTINGS -->
        <div v-if="tab === 'settings'">
            <div class="max-w-lg space-y-4">
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                    <h2 class="text-sm font-semibold text-gray-400 mb-4">Trading Parameters</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Risk per Trade (%)</label>
                            <input v-model="settings.risk_pct" @blur="saveSetting('risk_pct', settings.risk_pct)"
                                type="number" step="0.01" class="w-24 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white text-right focus:border-emerald-500 focus:outline-none">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Commission ($)</label>
                            <input v-model="settings.commission" @blur="saveSetting('commission', settings.commission)"
                                type="number" step="1" class="w-24 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white text-right focus:border-emerald-500 focus:outline-none">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Max Open Positions</label>
                            <input v-model="settings.max_positions" @blur="saveSetting('max_positions', settings.max_positions)"
                                type="number" step="1" class="w-24 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white text-right focus:border-emerald-500 focus:outline-none">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Scan Interval (minutes)</label>
                            <input v-model="settings.scan_interval_minutes" @blur="saveSetting('scan_interval_minutes', settings.scan_interval_minutes)"
                                type="number" step="5" class="w-24 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white text-right focus:border-emerald-500 focus:outline-none">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Auto-Trade Signals</label>
                            <input type="checkbox" v-model="autoTrade" @change="toggleAutoTrade"
                                class="rounded border-gray-600 bg-gray-800 text-emerald-500 focus:ring-emerald-500">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                    <h2 class="text-sm font-semibold text-gray-400 mb-4">Risk Management</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Min Signal Score</label>
                            <input v-model="settings.min_signal_score" @blur="saveSetting('min_signal_score', settings.min_signal_score)"
                                type="number" step="5" class="w-24 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white text-right focus:border-emerald-500 focus:outline-none">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Max Drawdown Limit (%)</label>
                            <input v-model="settings.max_drawdown_pct" @blur="saveSetting('max_drawdown_pct', settings.max_drawdown_pct)"
                                type="number" step="1" class="w-24 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white text-right focus:border-emerald-500 focus:outline-none">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Daily Loss Limit (%)</label>
                            <input v-model="settings.daily_loss_limit_pct" @blur="saveSetting('daily_loss_limit_pct', settings.daily_loss_limit_pct)"
                                type="number" step="0.5" class="w-24 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white text-right focus:border-emerald-500 focus:outline-none">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">Slippage (%)</label>
                            <input v-model="settings.slippage_pct" @blur="saveSetting('slippage_pct', settings.slippage_pct)"
                                type="number" step="0.001" class="w-24 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white text-right focus:border-emerald-500 focus:outline-none">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-300">8 EMA Trailing Stop</label>
                            <input type="checkbox" :checked="settings.trailing_stop_enabled === 'true'"
                                @change="saveSetting('trailing_stop_enabled', $event.target.checked ? 'true' : 'false'); settings.trailing_stop_enabled = $event.target.checked ? 'true' : 'false'"
                                class="rounded border-gray-600 bg-gray-800 text-emerald-500 focus:ring-emerald-500">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-xl p-4 border border-red-900/50">
                    <h2 class="text-sm font-semibold text-red-400 mb-3">Danger Zone</h2>
                    <button @click="resetPortfolio"
                        class="bg-red-600 hover:bg-red-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-colors">
                        Reset Portfolio ($150,000)
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Wipes all positions, trades, and scanner history.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div v-if="toast" class="fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm shadow-xl z-50"
        :class="toast.type === 'error' ? 'border-red-500/50 text-red-400' : 'border-emerald-500/50 text-emerald-400'">
        {{ toast.message }}
    </div>
</div>

<script>
const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

createApp({
    setup() {
        const tab = ref('dashboard');
        const tabs = [
            { id: 'dashboard', label: 'Dashboard' },
            { id: 'positions', label: 'Positions' },
            { id: 'journal', label: 'Journal' },
            { id: 'scanner', label: 'Scanner' },
            { id: 'settings', label: 'Settings' },
        ];

        const portfolio = reactive({ cash: 0, positions_value: 0, total_equity: 0, unrealized_pnl: 0, net_pnl: 0, starting_cash: 150000 });
        const positions = ref([]);
        const journal = ref([]);
        const scanResults = ref([]);
        const stats = reactive({ total_trades: 0, wins: 0, losses: 0, win_pct: 0, avg_win_pct: 0, avg_loss_pct: 0, profit_factor: 0, net_pnl: 0, max_drawdown: 0 });
        const equityCurve = ref([]);
        const settings = reactive({});
        const scanning = ref(false);
        const autoTrade = ref(true);
        const lastScanResult = ref(null);
        const toast = ref(null);
        const notifications = ref([]);
        const regime = ref('');
        let equityChart = null;

        const userEmail = ref(null);

        const buyForm = reactive({
            symbol: '', price: null, stop_price: null,
            target1_price: null, target2_price: null, shares: null,
        });

        const statCards = computed(() => [
            { label: 'Total Trades', value: stats.total_trades },
            { label: 'Win Rate', value: stats.win_pct + '%', color: stats.win_pct >= 50 ? 'text-emerald-400' : 'text-red-400' },
            { label: 'Avg Win', value: stats.avg_win_pct + '%', color: 'text-emerald-400' },
            { label: 'Avg Loss', value: stats.avg_loss_pct + '%', color: 'text-red-400' },
            { label: 'Profit Factor', value: stats.profit_factor, color: stats.profit_factor >= 1 ? 'text-emerald-400' : 'text-red-400' },
            { label: 'Net P&L', value: fmt(stats.net_pnl), color: stats.net_pnl >= 0 ? 'text-emerald-400' : 'text-red-400' },
            { label: 'Max Drawdown', value: stats.max_drawdown + '%', color: 'text-red-400' },
            { label: 'Wins / Losses', value: `${stats.wins} / ${stats.losses}` },
        ]);

        function fmt(n) {
            if (n == null) return '$0.00';
            const sign = n < 0 ? '-' : '';
            return sign + '$' + Math.abs(n).toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // API key from query string if set (e.g. ?api_key=xxx)
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('api_key') || '';

        async function api(path, opts = {}) {
            const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
            if (apiKey) headers['X-API-Key'] = apiKey;
            try {
                const res = await fetch('/api' + path, { ...opts, headers });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ detail: 'Request failed' }));
                    throw new Error(err.detail || 'Request failed');
                }
                return res.json();
            } catch (e) {
                showToast(e.message, 'error');
                throw e;
            }
        }

        function showToast(message, type = 'success') {
            toast.value = { message, type };
            setTimeout(() => toast.value = null, 3000);
        }

        async function fetchAll() {
            const [p, pos, j, sc, st, eq, set, notifs] = await Promise.all([
                api('/portfolio').catch(() => null),
                api('/positions').catch(() => []),
                api('/trades').catch(() => []),
                api('/scanner/results').catch(() => []),
                api('/stats').catch(() => null),
                api('/equity-curve').catch(() => []),
                api('/settings').catch(() => ({})),
                api('/notifications').catch(() => []),
            ]);
            if (p) Object.assign(portfolio, p);
            positions.value = pos || [];
            journal.value = j || [];
            scanResults.value = sc || [];
            if (st) Object.assign(stats, st);
            equityCurve.value = eq || [];
            notifications.value = notifs || [];
            if (set) {
                Object.assign(settings, set);
                autoTrade.value = set.auto_trade === 'true';
            }
            await nextTick();
            renderChart();
        }

        function renderChart() {
            const canvas = document.getElementById('equityChart');
            if (!canvas || equityCurve.value.length === 0) return;

            if (equityChart) equityChart.destroy();
            equityChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: equityCurve.value.map(e => e.date),
                    datasets: [{
                        label: 'Total Equity',
                        data: equityCurve.value.map(e => e.total_equity),
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280', font: { size: 10 } } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280', callback: v => '$' + v.toLocaleString() } },
                    }
                }
            });
        }

        async function manualBuy() {
            const f = buyForm;
            if (!f.symbol || !f.price || !f.stop_price || !f.target1_price || !f.target2_price) {
                showToast('Fill in all required fields', 'error'); return;
            }
            if (f.stop_price >= f.price) {
                showToast('Stop must be below entry price', 'error'); return;
            }
            if (f.target1_price <= f.price) {
                showToast('Target 1 must be above entry price', 'error'); return;
            }
            if (f.target2_price <= f.target1_price) {
                showToast('Target 2 must be above Target 1', 'error'); return;
            }
            if (f.shares && f.shares <= 0) {
                showToast('Shares must be positive', 'error'); return;
            }
            const body = { ...f, symbol: f.symbol.toUpperCase().trim() };
            if (!body.shares) delete body.shares;
            try {
                await api('/positions', { method: 'POST', body: JSON.stringify(body) });
                showToast(`Bought ${body.symbol}`);
                Object.assign(buyForm, { symbol: '', price: null, stop_price: null, target1_price: null, target2_price: null, shares: null });
                fetchAll();
            } catch (e) { /* toast already shown by api() */ }
        }

        async function closePosition(pos) {
            if (!confirm(`Close ${pos.shares} shares of ${pos.symbol}?`)) return;
            try {
                await api(`/positions/${pos.id}/close`, {
                    method: 'POST',
                    body: JSON.stringify({ price: pos.current_price, reason: 'manual' }),
                });
                showToast(`Closed ${pos.symbol}`);
                fetchAll();
            } catch (e) { /* toast already shown by api() */ }
        }

        async function runScan() {
            scanning.value = true;
            try {
                const result = await api('/scanner/run', { method: 'POST' });
                lastScanResult.value = result;
                showToast(`Scan complete: ${result.signals_found} signal(s)`);
                fetchAll();
            } finally {
                scanning.value = false;
            }
        }

        async function toggleAutoTrade() {
            await api('/settings', {
                method: 'PUT',
                body: JSON.stringify({ key: 'auto_trade', value: autoTrade.value ? 'true' : 'false' }),
            });
        }

        async function saveSetting(key, value) {
            await api('/settings', {
                method: 'PUT',
                body: JSON.stringify({ key, value: String(value) }),
            });
            showToast(`${key} updated`);
        }

        async function resetPortfolio() {
            if (!confirm('Reset portfolio to $150,000? This deletes ALL trades and positions.')) return;
            if (!confirm('Are you sure? This cannot be undone.')) return;
            await api('/reset', { method: 'POST' });
            showToast('Portfolio reset');
            fetchAll();
        }

        async function fetchUser() {
            try {
                const res = await fetch('/auth/me');
                if (res.ok) {
                    const data = await res.json();
                    userEmail.value = data.email;
                }
            } catch (e) {
                // Not logged in or auth not configured
            }
        }

        onMounted(() => {
            fetchUser();
            fetchAll();
            // Poll every 30s
            setInterval(() => {
                if (tab.value === 'dashboard' || tab.value === 'positions') fetchAll();
            }, 30000);
        });

        return {
            tab, tabs, portfolio, positions, journal, scanResults, stats, equityCurve,
            settings, scanning, autoTrade, lastScanResult, toast, buyForm, statCards,
            notifications, regime, userEmail,
            fmt, manualBuy, closePosition, runScan, toggleAutoTrade, saveSetting, resetPortfolio,
        };
    }
}).mount('#app');
</script>
</body>
</html>
